<html>
	<head>
		<title>music-player!</title>
		<script src="lib/jquery-2.0.3.min.js"></script>
		<script src="lib/jquery-ui.min.js"></script>
		<script src="lib/canvasjs.min.js"></script>
		<script src="lib/async.js"></script>
		<link rel="stylesheet" type="text/css" href="lib/jquery-ui.min.css" />
		<style type="text/css">
		#main_graph { 
			width: 85%;
			height: 85%;
		}
		#menu {
			float: right;
			width: 10%;
		}
		</style>
		<script type="text/javascript">
		$(document).ready( function( ){

			main_graph	= { }
			songs		= { }

			// Hide all the items that should be hidden in the start.
			$(".hide").hide( );

			$("#menu").children( "a" ).each( function( a ){
				_name = $(a).html();
				$(a).click( function( ){
					window["show_"+_name]( );
				} );
			} );

			// Enumerate the available options here.. somewhat modularized for other systems in the future.
			options = [ "liveness", "tempo", "speechiness", "acousticness", "duration", "mode", "key", "energy", "time_signature", "duration", "loudness", "valence",  "danceability" ];

			show_loading = function( cb ){
				// Show the loading dialog and progress bar..
				$("#loading").dialog( { modal: true,
							title: "Loading..",
							draggable: false, 
							resizable: false,
							minWidth: 400,
							minHeight: 200 } );
				$("#progressbar").progressbar( { value: false } );
				return cb( null );
			}

			hide_loading = function( cb ){
				$("#progressbar").progressbar( "destroy" );
				$("#loading").dialog( "close" );
				return cb( null );
			}

			setup_canvas = function( cb ){
				main_graph = new CanvasJS.Chart( "main_graph", {	"title": { "text": "Main Graph" },
											"data": { } } );
				main_graph.render( );
				return cb( null );
			}
			
			setup_options = function( cb ){

				// Iterate through all the options and fill in the div..
				$("#options").append( "<table id='options_table'>" );
				for( var i=0; i<options.length; i++ ){
					option = options[i];

					$("#options_table").append( "<tr><td><input checked='checked' type='checkbox' name='" + option +"'></td><td>" + option + "</td></tr>" );
				}
				$("#options").append("</table>");
				$("#options").append( "<p><input type='submit' id='update_graph_button' value='Update Graph' /></p>" );

				$("#update_graph_button").button( ).click( function( event ){
					// Straight forward logic.. update!
					async.series( [ show_loading, clear_songs, load_songs, update_graph, hide_loading ], function( err, res ){
						
					} );
				} );
				

				// Setup the options dialog.
				$("#options").dialog( { modal: false,
							title: "Options",
							draggable: true,
							resizable: true,
							autoOpen: false,
							minWidth: 300,
							minHeight: 500 } );

				return cb( null );
			}

			setup_menu = function( cb ){
				$("#menu").menu( );
				$("#menu").show( );
				return cb( null );
			}

			selected_options = function( ){
				// This function returns a list of selected options.
				_r = [ ];
				boxes = $("#options_table :checkbox");
				for( var i=0; i<boxes.length; i++ ){
					box = $(boxes[i]);
					if( box.prop("checked") ){
						_r.push( box.attr( "name" ) );
					}
				}
				return _r;
			}

			clear_songs = function( cb ){
				// Just a handy function that clears the songs we know about.
				songs = { }
				return cb( null );
			}

			load_songs = function( cb ){
				// This function queries for the basic information.. it uses
				// selected_options and sets the value of the global songs object.

				_data		= { }
				_data['pca']	= selected_options( );
				$.ajax( "/pca/basic", { "data": _data,
							"complete": function( res ){
								songs = res.responseJSON;
								return cb( null );
							},
							"error": function( err ){
								return cb( err );
							} } );
			}

			update_graph = function( cb ){
				// This function updates the main graph with the contents of songs.
				main_graph.options.data = [ {	type: "scatter",
								markerSize: 15,
								dataPoints: songs,
								toolTipContent: "{title}<br />{artist}",
								click: function( e ){
									$("#player").html("<audio controls='controls' autoplay='autoplay'><source='/song/" + e.dataPoint._id + "' type='audio/mpeg' /></audio>" );
								} } ];
				main_graph.render( );
				return cb( null );
			}

			async.series( [ show_loading, setup_canvas, setup_options, setup_menu, load_songs, update_graph, hide_loading ], function( err, res ){
				
			} );
			
		} );
		</script>
	</head>
	<body>
		<div id="loading">
			<div class="message">The hamsters are running. Hold on!</div>
			<p><div id="progressbar"></div></p>
			<div class="detail_message"></div>
		</div>
		<div id="options" class="hide">
		</div>
		<div id="menu" class="hide">
			<li><a href='#' onclick="$('#options').dialog('open');">Options</a></li>
			<li><a href='#'>About</a></li>
		</div>
		<div id="main_graph"></div>
		<div id="player"></div>
	</body>
</html>

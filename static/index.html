<html>
	<head>
		<title>music-player!</title>
		<script src="lib/jquery-2.0.3.min.js"></script>
		<script src="lib/jquery-ui.min.js"></script>
		<script src="lib/jquery.jplayer.min.js"></script>
		<script src="lib/canvasjs.min.js"></script>
		<script src="lib/async.js"></script>
		<link rel="stylesheet" type="text/css" href="lib/jquery-ui.min.css" />
		<link rel="stylesheet" type="text/css" href="lib/jplayer.blue.monday.css" />
		<style type="text/css">
		#main_graph { 
			width: 85%;
			height: 85%;
		}
		#menu {
			float: right;
			width: 10%;
		}
		</style>
		<script type="text/javascript">
		$(document).ready( function( ){

			main_graph	= { }
			songs		= { }

			// Hide all the items that should be hidden in the start.
			$(".hide").hide( );

			// Enumerate the available options here.. somewhat modularized for other systems in the future.
			options = [ "duration", "tempo", "liveness", "speechiness", "acousticness", "mode", "key", "energy", "time_signature", "loudness", "valence",  "danceability" ];

			$("#about").dialog( { title: "About.", draggable: false, resizable: false, minWidth: 400, minHeight: 200, autoOpen: false } );

			show_loading = function( cb ){
				// Show the loading dialog and progress bar..
				$("#loading").dialog( { modal: true,
							title: "Loading..",
							draggable: false, 
							resizable: false,
							minWidth: 400,
							minHeight: 200 } );
				$("#progressbar").progressbar( { value: false } );
				return cb( null );
			}

			hide_loading = function( cb ){
				$("#progressbar").progressbar( "destroy" );
				$("#loading").dialog( "close" );
				return cb( null );
			}

			setup_canvas = function( cb ){
				main_graph = new CanvasJS.Chart( "main_graph", {	"title": { "text": "Main Graph" },
											"data": { },
											"toolTip": {
												"content": function( e ){
													// Rather than referencing this all the time..
													_dp = e.entries[0].dataPoint;

													// Define the return string that we'll concat to.
													_return = "Title: " + _dp["title"] + "<br />Artist: " + _dp["artist"] + "<br />";

													_selected_options = selected_options( );
													// Iterate over the tooltip_options..
													for( var i in _selected_options ){
														tool_tip = _selected_options[i];
														_return += tool_tip + ": " + _dp[tool_tip] + "<br />";
													}
													return _return;
												}
											} } );
				main_graph.render( );
				return cb( null );
			}
			
			setup_options = function( cb ){

				// Iterate through all the options and fill in the div..
				$("#options").append( "<table id='options_table'>" );
				for( var i=0; i<options.length; i++ ){
					option = options[i];
					$("#options_table").append( "<tr><td><input checked='checked' type='checkbox' name='" + option +"'></td><td>" + option + "</td></tr>" );
				}
				$("#options").append("</table>");
				$("#options").append( "<p><input type='submit' id='update_graph_button' value='Update Graph' /></p>" );

				$("#update_graph_button").button( ).click( function( event ){
					// Straight forward logic.. update!
					async.series( [ show_loading, clear_songs, load_songs, update_graph, hide_loading ], function( err, res ){
						
					} );
				} );
				

				// Setup the options dialog.
				$("#options").dialog( { modal: false,
							title: "Options",
							draggable: true,
							resizable: true,
							autoOpen: false,
							minWidth: 300,
							minHeight: 500 } );

				return cb( null );
			}

			setup_menu = function( cb ){
				$("#menu").menu( );
				$("#menu").show( );
				return cb( null );
			}

			selected_options = function( ){
				// This function returns a list of selected options.
				_r = [ ];
				boxes = $("#options_table :checkbox");
				for( var i=0; i<boxes.length; i++ ){
					box = $(boxes[i]);
					if( box.prop("checked") ){
						_r.push( box.attr( "name" ) );
					}
				}
				return _r;
			}

			clear_songs = function( cb ){
				// Just a handy function that clears the songs we know about.
				songs = { }
				return cb( null );
			}

			load_songs = function( cb ){
				// This function queries for the basic information.. it uses
				// selected_options and sets the value of the global songs object.

				_data		= { }
				_data['pca']	= selected_options( );
				$.ajax( "/pca/basic", { "data": _data,
							"complete": function( res ){
								songs = res.responseJSON;
								return cb( null );
							},
							"error": function( err ){
								return cb( err );
							} } );
			}

			update_graph = function( cb ){
				// This function updates the main graph with the contents of songs.
				main_graph.options.data = [ {	type: "scatter",
								markerSize: 15,
								dataPoints: songs,
								click: function( e ){
									$("#player").jPlayer( {
										ready: function( ){
											$(this).jPlayer( "setMedia", {
												mp3: "/song/" + e.dataPoint._id
											} );
										},
										swfPath: "/lib",
										supplied: "mp3"
									} );
								} } ];

				main_graph.render( );
				return cb( null );
			}

			async.series( [ show_loading, setup_canvas, setup_options, setup_menu, load_songs, update_graph, hide_loading ], function( err, res ){
				
			} );
			
		} );
		</script>
	</head>
	<body>
		<div id="loading">
			<div class="message">The hamsters are running. Hold on!</div>
			<p><div id="progressbar"></div></p>
			<div class="detail_message"></div>
		</div>
		<div id="options" class="hide"></div>
		<div id="about" class="hide">
			<p>This is <a href='https://github.com/argylemachine/music-player'>music-player</a>. It is released open source under the <a href='https://raw.github.com/argylemachine/music-player/develop/LICENSE'>MIT</a> license.</p>
			<p>Original idea and inspiration came from <a href='http://thesis.flyingpudding.com/'>Music Box</a> by <a href='http://flyingpudding.com/'>Anita Shen Lillie</a>.</p>
		</div>
		<div id="menu" class="hide">
			<li><a href='#' onclick="$('#options').dialog('open');">Options</a></li>
			<li><a href='#' onclick="$('#about').dialog('open');">About</a></li>
		</div>
		<div id="main_graph"></div>
		<div id="player" class="jp-player"></div>
		<div id="jp_container" class="jp-audio">
			<div class="jp-type-single">
				<div class="jp-gui jp-interface">
					<ul class="jp-controls">
						<li><a href="javascript:;" class="jp-play" tabindex="1">play</a></li>
						<li><a href="javascript:;" class="jp-pause" tabindex="1">pause</a></li>
						<li><a href="javascript:;" class="jp-stop" tabindex="1">stop</a></li>
						<li><a href="javascript:;" class="jp-mute" tabindex="1" title="mute">mute</a></li>
						<li><a href="javascript:;" class="jp-unmute" tabindex="1" title="unmute">unmute</a></li>
						<li><a href="javascript:;" class="jp-volume-max" tabindex="1" title="max volume">max volume</a></li>
					</ul>
					<div class="jp-progress">
						<div class="jp-seek-bar">
							<div class="jp-play-bar"></div>
						</div>
					</div>
					<div class="jp-volume-bar">
						<div class="jp-volume-bar-value"></div>
					</div>
					<div class="jp-time-holder">
						<div class="jp-current-time"></div>
						<div class="jp-duration"></div>
						<ul class="jp toggles">
							<li><a href="javascript:;" class="jp-repeat" tabindex="1" title="repeat">repeat</a></li>
							<li><a href="javascript:;" class="jp-repeat-off" tabindex="1" title="repeat off">repeat off</a></li>
						</ul>
					</div>
				</div>
				<div class="jp-title">
					<ul><li>Bubble</li></ul>
				</div>
				<div class="jp-no-solution">
					<span>No compatible player</span>
					There was no compatable player technology found. You should update your browser, or allow the plugin to run if you want to use this site.
				</div>
			</div>
		</div>
	</body>
</html>

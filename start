#!./node_modules/coffee-script/bin/coffee

log	= require( "logging" ).from __filename
fs	= require "fs"
async	= require "async"
util	= require "util"
find	= require "find"

config	= { }

find_mp3_files = ( cb ) ->
	# This function finds mp3 files in config['directories']..
	async.map config['directories'], ( directory, cb ) ->
		find.file /\.mp3/, directory, ( files ) ->
			return cb null, files

	, ( err, file_arrays ) ->
		_r = [ ]
		async.each file_arrays, ( file_array, cb ) ->
			for file in file_array
				if file in _r
					continue
				_r.push file

			cb null
		, ( err ) ->
			cb null, _r

async.series [ ( cb ) ->
		log "Parsing config.."
		fs.readFile "config.json", ( err, data ) ->
			if err
				return cb err
			try
				config = JSON.parse data
				return cb null
			catch err
				return cb err
	, ( cb ) ->
		log "Validating config.."
		async.map [ "port", "directories", "echonest_api_key" ], ( req, cb ) ->
			if not config[req]?
				return cb "Field #{req} not found."
			cb null
		, ( err, res ) ->
			if err
				return cb err
			cb null
	, ( cb ) ->
		log "Searching directories for files.."
		find_mp3_files ( err, files ) ->
			log "Files are #{util.inspect files}"
			return cb null
	], ( err, res ) ->
		if err
			log "Unable to startup: #{err}"
			process.exit 1
		log "Startup complete!"

